// under MIT License (c) 2015 Brice Leroy <bbrriiccee@gmail.com>
function Collection(e,t){function s(){return n.length}function o(){return n.length===0}function u(e){r={};if(o())return this;var t=n;n=[];if(!e){T("remove",t);T("change")}return this}function a(e){var t,r,i=[];for(t=r=0;t!==false&&r<n.length;r++){t=e(n[r],r);if(t)i.push(t)}return i}function f(e){var t=[],r=0;a(function(r,i){if(e(r,n,i)){t.push(r)}});return new Collection(t)}function l(e,i,s){function a(t){if(o)return o(t);return t[e]===i}var o,u=[];if(arguments.length===1){if(typeof e==="function"){o=e}else{i=e;e=t}}for(var f=0;f<n.length;f++){if(a(n[f])){u.push(r[n[f][t]]);delete r[n[f][t]];n.splice(f,1);f=f-1}}if(!s&&u.length>0){T("change");T("remove",u)}return this}function c(e){var t=[];a(function(n){var r=true;for(var i in e){if(typeof e[i]==="function"){if(!e[i](n[i]))r=false}else if(Array.isArray(e[i])){var s=false;for(var o=0;o<e[i].length;o++){if(e[i][o]===n[i])s=true}r=r&&s}else{if(e[i]!==n[i])r=false}}if(r)t.push(n)});return new Collection(t)}function h(e){var t=new RegExp(e,"i");return function(e){return t.test(e)}}function p(e){var t=e.split(" ");var n=new RegExp(t.join("[^\\s]*\\s.*"),"i");return function(e){return n.test(e)}}function d(e){return function(t){return t<=e}}function v(e){return function(t){return t>=e}}function m(e,t){return function(n){return n>=Math.min(e,t)&&n<=Math.max(e,t)}}function g(e){var t=[];if(typeof e==="string"){a(function(n){t.push(n[e])})}else{a(function(n){var r={};for(var i=0;i<e.length;i++){r[e[i]]=n[e[i]]}t.push(r)})}return t}function y(e){if(o())return this;n.reverse();if(!e){T("change");T("sort")}return this}function b(e,t,r){if(o())return this;if(t){n.sort(function(n,r){return t(n[e],r[e])})}else{n.sort(function(t,n){var r=t[e];var i=n[e];if(r===i)return 0;if(i===[i,r].sort()[0])return 1;return-1})}if(!r){T("change");T("sort")}return this}function w(e,n){if(arguments.length===1||e===t){return r[e]}var i=null;a(function(t){if(t.hasOwnProperty(e)&&t[e]==n){i=t;return false}});return i}function E(e,i){e=[].concat(e);if(e.length===0)return this;for(var s,o=0;o<e.length;o++){s=e[o];l(s[t]);n.push(s);r[s[t]]=s}if(!i){T("add",e);T("change")}return this}function S(e,t){if(!i[e]){i[e]=[]}i[e].push(t);return function(){x(e,t)}}function x(e,t){var n=i[e].indexOf(t);if(n>-1){i[e].splice(n,1)}}function T(e,t){if(e in i){for(var n=0,r=i[e].length;n<r;n++){i[e][n](t)}}}function N(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)}function C(){var e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx";return e.replace(/[xy]/g,N)}var n=[];var r={};var i={};t=t||"id";if(e){E(e)}return{uuid:C,isEmpty:o,empty:u,size:s,models:n,add:E,filter:f,each:a,where:c,min:v,max:d,within:m,contains:h,fuzzy:p,select:g,sort:b,get:w,remove:l,reverse:y,on:S,off:x,fire:T}}
