// under MIT License (c) 2015 Brice Leroy <bbrriiccee@gmail.com>
function Collection(n,r){function e(n){if(K){var e=[];return r.forEach(function(r){e.push(n[r])}),t(e)}return n[r]}function t(n){return K?n.join(V):n}function i(){return b.length}function o(){return 0===b.length}function u(n){if(j={},o())return this;var r=b;return b.length=0,n||(O("remove",r),O("change")),this}function f(n){var r,e,t=[];for(r=e=0;r!==!1&&e<b.length;e++)r=n(b[e],e),r&&t.push(r);return t}function a(n){var e=[];return f(function(r,t){n(r,b,t)&&e.push(r)}),new Collection(e,r)}function c(n,r,e){return l(n,r,e,!0)}function l(n,i,o,u){function f(n){return u?!a(n):a(n)}function a(t){return n===r?Array.isArray(i)?K?i.indexOf(e(t))>-1:i.indexOf(t[n])>-1:K?e(t)===i:t[n]===i:"undefined"==typeof i?n(t):Array.isArray(i)?i.indexOf(t[n])>-1:"function"==typeof i?i(t[n]):t[n]===i}var c,l=[];"undefined"==typeof i&&"function"!=typeof n&&(K?Array.isArray(n[0])?(i=[],n.forEach(function(n){i.push(t(n))})):i=t(n):i=n,n=r);for(var s=b.length-1;s>=0;s--)c=b[s],f(c)&&(l.push(j[e(c)]),delete j[e(c)],b.splice(s,1));return!o&&l.length>0&&(O("change"),O("remove",l)),this}function s(n){return h(n,!0)}function h(n,e){var t,i;return i=f(function(r){t=!0;for(var i in n)if("function"==typeof n[i]){if(!n[i](r[i])){t=!1;break}}else if(Array.isArray(n[i])){if(-1===n[i].indexOf(r[i])){t=!1;break}}else if(n[i]!==r[i]){t=!1;break}return!t&&e||t&&!e?r:void 0}),new Collection(i,r)}function p(n){var r=new RegExp(n,"i");return function(n){return r.test(n)}}function v(n){var r=n.split(" "),e=new RegExp(r.join("[^\\s]*\\s.*"),"i");return function(n){return e.test(n)}}function d(n){return function(r){return n>=r}}function x(n){return function(r){return r>=n}}function y(n,r){return function(e){return e>=Math.min(n,r)&&e<=Math.max(n,r)}}function g(n){var r=[];return f("string"==typeof n?function(e){r.push(e[n])}:Array.isArray(n)?function(e){for(var t={},i=0;i<n.length;i++)t[n[i]]=e[n[i]];r.push(t)}:function(e){var t={};for(var i in n)t[i]="function"==typeof n[i]?n[i](e):e[n[i]];r.push(t)}),r}function m(n){return o()?this:(b.reverse(),n||(O("change"),O("sort")),this)}function _(n,r,e){return o()?this:(b.sort(r?function(e,t){return r(e[n],t[n])}:function(r,e){var t=r[n],i=e[n];return t===i?0:i===[i,t].sort()[0]?1:-1}),e||(O("change"),O("sort")),this)}function w(n,r){var e=n*r,t=e-n;return t=t>b.length?b.length:t>0?t:0,e=e>b.length?b.length:e,{page:r,pages:Math.ceil(b.length/n),has_previous:r>1,has_next:e<b.length,from:t,to:e-1,models:b.slice(t,e)}}function k(n,e){if(1===arguments.length||n===r)return j[t(n)];var i=null;return f(function(r){return r.hasOwnProperty(n)&&r[n]==e?(i=r,!1):void 0}),i}function C(n,t){if(n=[].concat(n),0===n.length)return this;for(var i,o,u=0;u<n.length;u++)o=n[u],i=e(o),i in j&&l(r,i),b.push(o),j[i]=o;return t||(O("add",n),O("change")),this}function A(n,r){return z[n]||(z[n]=[]),z[n].push(r),function(){E(n,r)}}function E(n,r){var e=z[n].indexOf(r);e>-1&&z[n].splice(e,1)}function O(n,r){if(n in z)for(var e=0,t=z[n].length;t>e;e++)z[n][e](r)}function M(n){var r=16*Math.random()|0,e="x"==n?r:3&r|8;return e.toString(16)}function P(){var n="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx";return n.replace(/[xy]/g,M)}var b=[],j={},z={},V=String.fromCharCode(31);r=r||"id";var K=Array.isArray(r);return n&&C(n),{_getPKValue:e,primary_key:r,uuid:P,isEmpty:o,empty:u,size:i,models:b,add:C,filter:a,each:f,where:h,keep:c,page:w,not:s,min:x,max:d,within:y,contains:p,fuzzy:v,select:g,sort:_,get:k,remove:l,reverse:m,on:A,off:E,fire:O}}function CollectionView(n,r){var e=n.where(r);return n.on("add",function(t){var i=new Collection(t,n.primary_key).where(r);e._add(i.models)}),n.on("remove",function(r){var t=new Collection(r,n.primary_key);e._remove(t.select(n.primary_key))}),e._add=e.add,e._remove=e.remove,e.add=n.add,e.empty=n.empty,e.keep=n.keep,e.remove=n.remove,e}function CollectionProxy(n){var r=new Collection([],n.primary_key);return r.proxied=n,r._add=r.add,r.add=function(n){var e=[];n=[].concat(n);for(var t=0;t<n.length;t++)r.proxied.get(r._getPKValue(n[t]))&&e.push(n[t]);return r._add(e)},n.on("remove",function(e){var t=new Collection(e,n.primary_key);r.remove(t.select(n.primary_key))}),r}Collection.join=function(n,r,e){var t,i,o,u,f,a,c={};for(i in n)c[i]=new Collection(n[i].models,n[i].primary_key);var l={};for(var s in e)i=s.split(".")[0],o=s.split(".")[1],a=e[s],i in l||(l[i]={}),l[i][o]=a;for(i in l)c[i]=c[i].where(l[i]);return r.forEach(function(n){f=n[1],u=n[0],i=c[u.split(".")[0]],o=u.split(".")[1],t=i.select(o),i=c[f.split(".")[0]],o=f.split(".")[1],i.keep(o,t)}),c};
