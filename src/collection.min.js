// under MIT License (c) 2015 Brice Leroy <bbrriiccee@gmail.com>
function Collection(n,r){function t(n){if(P){var t=[];return r.forEach(function(r){t.push(n[r])}),e(t)}return n[r]}function e(n){return P?n.join(S):n}function i(){return j.length}function u(){return 0===j.length}function o(n){if(z={},u())return this;var r=j;return j=[],n||(M("remove",r),M("change")),this}function f(n){var r,t,e=[];for(r=t=0;r!==!1&&t<j.length;t++)r=n(j[t],t),r&&e.push(r);return e}function c(n){var t=[];return f(function(r,e){n(r,j,e)&&t.push(r)}),new Collection(t,r)}function a(n,r,t){return s(n,r,t,!0)}function s(n,i,u,o){function f(n){return o?!c(n):c(n)}function c(e){return n===r?Array.isArray(i)?P?i.indexOf(t(e))>-1:i.indexOf(e[n])>-1:P?t(e)===i:e[n]===i:"undefined"==typeof i?n(e):Array.isArray(i)?i.indexOf(e[n])>-1:"function"==typeof i?i(e[n]):e[n]===i}var a,s=[];"undefined"==typeof i&&"function"!=typeof n&&(P?Array.isArray(n[0])?(i=[],n.forEach(function(n){i.push(e(n))})):i=e(n):i=n,n=r);for(var h=j.length-1;h>=0;h--)a=j[h],f(a)&&(s.push(z[t(a)]),delete z[t(a)],j.splice(h,1));return!u&&s.length>0&&(M("change"),M("remove",s)),this}function h(n){return l(n,!0)}function l(n,t){var e,i;return i=f(function(r){e=!0;for(var i in n)if("function"==typeof n[i]){if(!n[i](r[i])){e=!1;break}}else if(Array.isArray(n[i])){if(-1===n[i].indexOf(r[i])){e=!1;break}}else if(n[i]!==r[i]){e=!1;break}return!e&&t||e&&!t?r:void 0}),new Collection(i,r)}function x(n){var r=new RegExp(n,"i");return function(n){return r.test(n)}}function p(n){var r=n.split(" "),t=new RegExp(r.join("[^\\s]*\\s.*"),"i");return function(n){return t.test(n)}}function v(n){return function(r){return n>=r}}function g(n){return function(r){return r>=n}}function y(n,r){return function(t){return t>=Math.min(n,r)&&t<=Math.max(n,r)}}function d(n){var r=[];return f("string"==typeof n?function(t){r.push(t[n])}:Array.isArray(n)?function(t){for(var e={},i=0;i<n.length;i++)e[n[i]]=t[n[i]];r.push(e)}:function(t){var e={};for(var i in n)e[i]="function"==typeof n[i]?n[i](t):t[n[i]];r.push(e)}),r}function m(n){return u()?this:(j.reverse(),n||(M("change"),M("sort")),this)}function A(n,r,t){return u()?this:(j.sort(r?function(t,e){return r(t[n],e[n])}:function(r,t){var e=r[n],i=t[n];return e===i?0:i===[i,e].sort()[0]?1:-1}),t||(M("change"),M("sort")),this)}function w(n,r){var t=n*r,e=t-n;return e=e>j.length?j.length:e>0?e:0,t=t>j.length?j.length:t,{page:r,pages:Math.ceil(j.length/n),has_previous:r>1,has_next:t<j.length,from:e,to:t-1,models:j.slice(e,t)}}function k(n,t){if(1===arguments.length||n===r)return z[e(n)];var i=null;return f(function(r){return r.hasOwnProperty(n)&&r[n]==t?(i=r,!1):void 0}),i}function C(n,e){if(n=[].concat(n),0===n.length)return this;for(var i,u,o=0;o<n.length;o++)u=n[o],i=t(u),i in z&&s(r,i),j.push(u),z[i]=u;return e||(M("add",n),M("change")),this}function E(n,r){return R[n]||(R[n]=[]),R[n].push(r),function(){O(n,r)}}function O(n,r){var t=R[n].indexOf(r);t>-1&&R[n].splice(t,1)}function M(n,r){if(n in R)for(var t=0,e=R[n].length;e>t;t++)R[n][t](r)}function _(n){var r=16*Math.random()|0,t="x"==n?r:3&r|8;return t.toString(16)}function b(){var n="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx";return n.replace(/[xy]/g,_)}var j=[],z={},R={},S=String.fromCharCode(31);r=r||"id";var P=Array.isArray(r);return n&&C(n),{primary_key:r,uuid:b,isEmpty:u,empty:o,size:i,models:j,add:C,filter:c,each:f,where:l,keep:a,page:w,not:h,min:g,max:v,within:y,contains:x,fuzzy:p,select:d,sort:A,get:k,remove:s,reverse:m,on:E,off:O,fire:M}}Collection.join=function(n,r,t){var e,i,u,o,f,c,a={};for(i in n)a[i]=new Collection(n[i].models,n[i].primary_key);var s={};for(var h in t)i=h.split(".")[0],u=h.split(".")[1],c=t[h],i in s||(s[i]={}),s[i][u]=c;for(i in s)a[i]=a[i].where(s[i]);return r.forEach(function(n){f=n[1],o=n[0],i=a[o.split(".")[0]],u=o.split(".")[1],e=i.select(u),i=a[f.split(".")[0]],u=f.split(".")[1],i.keep(u,e)}),a};
