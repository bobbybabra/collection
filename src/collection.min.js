// under MIT License (c) 2015 Brice Leroy <bbrriiccee@gmail.com>
function Collection(n,r){function e(n){return G?i(t(n)):n[r]}function t(n){if(G){var e=[];return r.forEach(function(r){e.push(n[r])}),e}return n[r]}function i(n){return G?n.join(F):n}function o(){return q.length}function u(){return 0===q.length}function f(n){if(B={},u())return this;var r=q;return q.length=0,n||(N("remove",r),N("change")),this}function c(n,r){return f(r),K(n),this}function a(){return u()?void 0:(model=q[o()-1],p(model),model)}function s(n){var r,e,t=[];for(r=e=0;r!==!1&&e<q.length;e++)r=n(q[e],e),r&&t.push(r);return t}function l(n){var e=[];return s(function(r,t){n(r,q,t)&&e.push(r)}),new Collection(e,r)}function h(n,r,e){return p(n,r,e,!0)}function p(n,o,u,f){function c(n){return f?!a(n):a(n)}function a(t){return n===r?Array.isArray(o)?G?o.indexOf(e(t))>-1:o.indexOf(d(t,n))>-1:G?e(t)===o:d(t,n)===o:"undefined"==typeof o?n(t):Array.isArray(o)?o.indexOf(d(t,n))>-1:"function"==typeof o?o(d(t,n)):d(t,n)===o}var s,l,h=[];"undefined"==typeof o&&"function"!=typeof n&&((!Array.isArray(n)&&"object"==typeof n||!Array.isArray(n[0])&&"object"==typeof n[0])&&(l=[].concat(n),n=[],l.forEach(function(r){n.push(t(r))})),G?Array.isArray(n[0])?(o=[],n.forEach(function(n){o.push(i(n))})):o=i(n):o=n,n=r);for(var p=q.length-1;p>=0;p--)s=q[p],c(s)&&(h.push(B[e(s)]),delete B[e(s)],q.splice(p,1));return!u&&h.length>0&&(N("change"),N("remove",h)),this}function v(n){return x(n,!0)}function d(n,r){var e;if("string"==typeof r){if(r in n)return n[r];r=r.split(".")}for(;e=r.shift();){if(!(e in n))return;n=n[e]}return n}function y(n,r,e){var t,i,o=!0;for(t in r)if(i=d(n,t),"function"==typeof r[t]){if(!r[t](i)){o=!1;break}}else if(Array.isArray(r[t])){if(-1===r[t].indexOf(i)){o=!1;break}}else if(r[t]!==i){o=!1;break}return!o&&e||o&&!e?n:void 0}function x(n,e){var t=s(function(r){return y(r,n,e)});return new Collection(t,r)}function g(n){return w(y,[n])}function m(n){return w(y,[n,!0])}function w(n,r){function e(){o=0}function t(){return void 0!==i()?(o--,!0):!1}function i(){for(var e,t;t=q[o++];)if(e=n.apply(u,[t].concat(r)),void 0!==e)return e}var o=0,u=this;return{reset:e,next:i,hasNext:t}}function A(n){var r=new RegExp(n,"i");return function(n){return r.test(n)}}function _(n){var r=n.split(" "),e=new RegExp(r.join("[^\\s]*\\s.*"),"i");return function(n){return e.test(n)}}function k(n){return function(r){return n>=r}}function C(n){return function(r){return r>=n}}function O(n,r){return function(e){return e>=Math.min(n,r)&&e<=Math.max(n,r)}}function E(n){var e=[];return s(n===r&&G?function(n){e.push(t(n))}:"string"==typeof n?function(r){e.push(d(r,n))}:Array.isArray(n)?function(r){for(var t={},i=0;i<n.length;i++)t[n[i]]=d(r,n[i]);e.push(t)}:function(r){var t={};for(var i in n)t[i]="function"==typeof n[i]?n[i](r):d(r,n[i]);e.push(t)}),e}function b(n){return u()?this:(q.reverse(),n||(N("change"),N("sort")),this)}function j(n,r,e){return u()?this:(q.sort(r?function(e,t){return r(d(e,n),d(t,n))}:function(r,e){var t=d(r,n),i=d(e,n);return t===i?0:i===[i,t].sort()[0]?1:-1}),e||(N("change"),N("sort")),this)}function P(n,r){var e=n*r,t=e-n;return t=t>q.length?q.length:t>0?t:0,e=e>q.length?q.length:e,{page:r,pages:Math.ceil(q.length/n),has_previous:r>1,has_next:e<q.length,from:t,to:e-1,models:q.slice(t,e)}}function M(n,e){if(1===arguments.length||n===r)return B[i(n)];var t=null;return s(function(r){return r.hasOwnProperty(n)&&r[n]==e?(t=r,!1):void 0}),t}function z(n,t,i){if(t=t?t>o()?o():t:0,n=[].concat(n),0===n.length)return this;for(var u,f,c=0;c<n.length;c++)f=n[c],u=e(f),u in B&&(q.indexOf(B[u])<t&&t--,p(r,u)),q.splice(t++,0,f),B[u]=f;return i||(N("add",n),N("change")),this}function K(n,r){return z(n,o(),r),this}function S(n,r){return D[n]||(D[n]=[]),D[n].push(r),function(){V(n,r)}}function V(n,r){var e=D[n].indexOf(r);e>-1&&D[n].splice(e,1)}function N(n,r){if(n in D)for(var e=0,t=D[n].length;t>e;e++)D[n][e](r)}function R(n){var r=16*Math.random()|0,e="x"==n?r:3&r|8;return e.toString(16)}function W(){var n="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx";return n.replace(/[xy]/g,R)}var q=[],B={},D={},F=String.fromCharCode(31);r=r||"id";var G=Array.isArray(r);return n&&K(n),{getPKString:e,getPKValues:t,primary_key:r,uuid:W,isEmpty:u,empty:f,reset:c,size:o,models:q,add:K,insert:z,pop:a,filter:l,each:s,where:x,generator:w,gWhere:g,gNot:m,keep:h,page:P,not:v,min:C,max:k,within:O,contains:A,fuzzy:_,select:E,sort:j,get:M,remove:p,reverse:b,on:S,off:V,fire:N}}function CollectionView(n,r){var e=n.where(r);return n.on("add",function(t){var i=new Collection(t,n.primary_key).where(r);e._add(i.models)}),n.on("remove",function(r){var t=new Collection(r,n.primary_key);e._remove(t.select(n.primary_key))}),e._add=e.add,e._remove=e.remove,e.add=n.add,e.empty=n.empty,e.keep=n.keep,e.remove=n.remove,e}function CollectionProxy(n){var r=new Collection([],n.primary_key);return r.proxied=n,r._add=r.add,r.add=function(n){var e=[];n=[].concat(n);for(var t=0;t<n.length;t++)r.proxied.get(r.getPKValues(n[t]))&&e.push(n[t]);return r._add(e)},n.on("remove",function(e){var t=new Collection(e,n.primary_key);r.remove(t.select(n.primary_key))}),r}Collection.join=function(n,r,e){var t,i,o,u,f,c,a={};for(i in n)a[i]=new Collection(n[i].models,n[i].primary_key);var s={};for(var l in e)i=l.split(".")[0],o=l.substring(l.indexOf(".")+1),c=e[l],i in s||(s[i]={}),s[i][o]=c;for(i in s)a[i]=a[i].where(s[i]);return r.forEach(function(n){f=n[1],u=n[0],i=a[u.split(".")[0]],o=u.split(".")[1],t=i.select(o),i=a[f.split(".")[0]],o=f.split(".")[1],i.keep(o,t)}),a};
