// under MIT License (c) 2015 Brice Leroy <bbrriiccee@gmail.com>
function Collection(n,t){function r(){return b.length}function e(){return 0===b.length}function i(n){if(z={},e())return this;var t=b;return b=[],n||(E("remove",t),E("change")),this}function u(n){var t,r,e=[];for(t=r=0;t!==!1&&r<b.length;r++)t=n(b[r],r),t&&e.push(t);return e}function o(n){var t=[];return u(function(r,e){n(r,b,e)&&t.push(r)}),new Collection(t)}function f(n,t,r){return c(n,t,r,!0)}function c(n,r,e,i){function u(n){return i?!o(n):o(n)}function o(t){return"undefined"==typeof r?n(t):Array.isArray(r)?r.indexOf(t[n])>-1:"function"==typeof r?r(t[n]):t[n]===r}var f=[];"undefined"==typeof r&&"function"!=typeof n&&(r=n,n=t);for(var c=b.length-1;c>=0;c--)u(b[c])&&(f.push(z[b[c][t]]),delete z[b[c][t]],b.splice(c,1));return!e&&f.length>0&&(E("change"),E("remove",f)),this}function a(n){return s(n,!0)}function s(n,t){var r,e=[];return u(function(i){r=!0;for(var u in n)if("function"==typeof n[u]){if(!n[u](i[u])){r=!1;break}}else if(Array.isArray(n[u])){if(-1===n[u].indexOf(i[u])){r=!1;break}}else if(n[u]!==i[u]){r=!1;break}(!r&&t||r&&!t)&&e.push(i)}),new Collection(e)}function h(n){var t=new RegExp(n,"i");return function(n){return t.test(n)}}function l(n){var t=n.split(" "),r=new RegExp(t.join("[^\\s]*\\s.*"),"i");return function(n){return r.test(n)}}function x(n){return function(t){return n>=t}}function p(n){return function(t){return t>=n}}function v(n,t){return function(r){return r>=Math.min(n,t)&&r<=Math.max(n,t)}}function g(n){var t=[];return u("string"==typeof n?function(r){t.push(r[n])}:Array.isArray(n)?function(r){for(var e={},i=0;i<n.length;i++)e[n[i]]=r[n[i]];t.push(e)}:function(r){var e={};for(var i in n)e[i]="function"==typeof n[i]?n[i](r):r[n[i]];t.push(e)}),t}function d(n){return e()?this:(b.reverse(),n||(E("change"),E("sort")),this)}function y(n,t,r){return e()?this:(b.sort(t?function(r,e){return t(r[n],e[n])}:function(t,r){var e=t[n],i=r[n];return e===i?0:i===[i,e].sort()[0]?1:-1}),r||(E("change"),E("sort")),this)}function m(n,t){var r=n*t,e=r-n;return e=e>b.length?b.length:e>0?e:0,r=r>b.length?b.length:r,{page:t,pages:Math.ceil(b.length/n),has_previous:t>1,has_next:r<b.length,from:e,to:r-1,models:b.slice(e,r)}}function w(n,r){if(1===arguments.length||n===t)return z[n];var e=null;return u(function(t){return t.hasOwnProperty(n)&&t[n]==r?(e=t,!1):void 0}),e}function A(n,r){if(n=[].concat(n),0===n.length)return this;for(var e,i=0;i<n.length;i++)e=n[i],c(t,e[t],!0),b.push(e),z[e[t]]=e;return r||(E("add",n),E("change")),this}function k(n,t){return j[n]||(j[n]=[]),j[n].push(t),function(){C(n,t)}}function C(n,t){var r=j[n].indexOf(t);r>-1&&j[n].splice(r,1)}function E(n,t){if(n in j)for(var r=0,e=j[n].length;e>r;r++)j[n][r](t)}function M(n){var t=16*Math.random()|0,r="x"==n?t:3&t|8;return r.toString(16)}function O(){var n="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx";return n.replace(/[xy]/g,M)}var b=[],z={},j={};return t=t||"id",n&&A(n),{uuid:O,isEmpty:e,empty:i,size:r,models:b,add:A,filter:o,each:u,where:s,keep:f,page:m,not:a,min:p,max:x,within:v,contains:h,fuzzy:l,select:g,sort:y,get:w,remove:c,reverse:d,on:k,off:C,fire:E}}Collection.join=function(n,t,r){var e,i,u,o,f,c,a={};for(i in n)a[i]=new Collection(n[i].models);var s={};for(var h in r)i=h.split(".")[0],u=h.split(".")[1],c=r[h],i in s||(s[i]={}),s[i][u]=c;for(i in s)a[i]=a[i].where(s[i]);return t.forEach(function(n){f=n[1],o=n[0],i=a[o.split(".")[0]],u=o.split(".")[1],e=i.select(u),i=a[f.split(".")[0]],u=f.split(".")[1],i.keep(u,e)}),a};
