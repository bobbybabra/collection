// under MIT License (c) 2015 Brice Leroy <bbrriiccee@gmail.com>
function Collection(n,t){function r(){return C.length}function e(){return 0===C.length}function i(n){if(E={},e())return this;var t=C;return C=[],n||(b("remove",t),b("change")),this}function u(n){var t,r,e=[];for(t=r=0;t!==!1&&r<C.length;r++)t=n(C[r],r),t&&e.push(t);return e}function o(n){var t=[];return u(function(r,e){n(r,C,e)&&t.push(r)}),new Collection(t)}function f(n,r,e){function i(t){return"undefined"==typeof r?n(t):Array.isArray(r)?r.indexOf(t[n])>-1:"function"==typeof r?r(t[n]):t[n]===r}var u=[];1===arguments.length&&"function"!=typeof n&&(r=n,n=t);for(var o=C.length-1;o>=0;o--)i(C[o])&&(u.push(E[C[o][t]]),delete E[C[o][t]],C.splice(o,1));return!e&&u.length>0&&(b("change"),b("remove",u)),this}function c(n){return a(n,!0)}function a(n,t){var r,e=[];return u(function(i){r=!0;for(var u in n)if("function"==typeof n[u]){if(!n[u](i[u])){r=!1;break}}else if(Array.isArray(n[u])){if(-1===n[u].indexOf(i[u])){r=!1;break}}else if(n[u]!==i[u]){r=!1;break}(!r&&t||r&&!t)&&e.push(i)}),new Collection(e)}function s(n){var t=new RegExp(n,"i");return function(n){return t.test(n)}}function h(n){var t=n.split(" "),r=new RegExp(t.join("[^\\s]*\\s.*"),"i");return function(n){return r.test(n)}}function x(n){return function(t){return n>=t}}function l(n){return function(t){return t>=n}}function g(n,t){return function(r){return r>=Math.min(n,t)&&r<=Math.max(n,t)}}function v(n){var t=[];return u("string"==typeof n?function(r){t.push(r[n])}:Array.isArray(n)?function(r){for(var e={},i=0;i<n.length;i++)e[n[i]]=r[n[i]];t.push(e)}:function(r){var e={};for(var i in n)e[i]="function"==typeof n[i]?n[i](r):r[n[i]];t.push(e)}),t}function p(n){return e()?this:(C.reverse(),n||(b("change"),b("sort")),this)}function y(n,t,r){return e()?this:(C.sort(t?function(r,e){return t(r[n],e[n])}:function(t,r){var e=t[n],i=r[n];return e===i?0:i===[i,e].sort()[0]?1:-1}),r||(b("change"),b("sort")),this)}function d(n,t){var r=n*t,e=r-n;return e=e>C.length?C.length:e>0?e:0,r=r>C.length?C.length:r,{page:t,has_previous:t>1,has_next:r<C.length,from:e,to:r-1,models:C.slice(e,r)}}function m(n,r){if(1===arguments.length||n===t)return E[n];var e=null;return u(function(t){return t.hasOwnProperty(n)&&t[n]==r?(e=t,!1):void 0}),e}function w(n,r){if(n=[].concat(n),0===n.length)return this;for(var e,i=0;i<n.length;i++)e=n[i],f(t,e[t],!0),C.push(e),E[e[t]]=e;return r||(b("add",n),b("change")),this}function A(n,t){return M[n]||(M[n]=[]),M[n].push(t),function(){O(n,t)}}function O(n,t){var r=M[n].indexOf(t);r>-1&&M[n].splice(r,1)}function b(n,t){if(n in M)for(var r=0,e=M[n].length;e>r;r++)M[n][r](t)}function k(n){var t=16*Math.random()|0,r="x"==n?t:3&t|8;return r.toString(16)}function z(){var n="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx";return n.replace(/[xy]/g,k)}var C=[],E={},M={};return t=t||"id",n&&w(n),{uuid:z,isEmpty:e,empty:i,size:r,models:C,add:w,filter:o,each:u,where:a,page:d,not:c,min:l,max:x,within:g,contains:s,fuzzy:h,select:v,sort:y,get:m,remove:f,reverse:p,on:A,off:O,fire:b}}
